<!doctype html>
<html>

<head>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> Music Visualiser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.1/p5.js"></script>
    <link rel="stylesheet" type="text/css" href="custom.css">
</head>

<body>

<h1> Homework#2: Music Visualiser </h1>

<input type="button" name="pause" onclick="{pause = !pause}">

<script>

var context = new (window.AudioContext || window.webkitAudioContext)();
var musicBuffer;

var analyser1 = context.createAnalyser()
analyser1.fftSize = 1024
var analyser2 = context.createAnalyser()
analyser2.fftSize = 1024
var byteFrequencyData = new Uint8Array(analyser1.frequencyBinCount);
var timeDomainData = new Uint8Array(analyser2.frequencyBinCount);

var music = new XMLHttpRequest();
music.open("Get","noTomorrow.m4a",true);
music.responseType = "arraybuffer";
music.onload = function(){
    context.decodeAudioData(music.response, function(buffer){musicBuffer = buffer;
    	var source = context.createBufferSource()
        source.buffer = buffer
        source.connect(analyser1).connect(analyser2).connect(context.destination) 
        source.start()
    });
}
music.send();

pause = false

var canvasW = 640
var canvasH = 640

function setup() {
  createCanvas(canvasW, canvasH);
  background(0,0,0)
}

radius1 = 200
radius2 = 100
var hueV = 0

oldPower = 0

function draw() {
	if(!pause){


		background('rgba(0,0,0,0.1)')
		
		analyser2.getByteFrequencyData(byteFrequencyData)

		highestFreq = getMaxFreqIndex(byteFrequencyData)
		
		
		stroke('hsb('+highestFreq*360/byteFrequencyData.length+',60,30)')







		timeDomain()

 	} 
}

function getMaxFreqIndex(data){
	maxV = 0
	maxI = 0
	for(var i = 0; i < data.length; ++i){
		if(data[i] >= maxV){
			maxV = data[i]
			maxI = i
		}
	}
}

theta = 0
function timeDomain(){
	analyser2.getByteTimeDomainData(timeDomainData)

	power = 70+getEnergy(timeDomainData)
	var distance = 0
	if(power-oldPower > 0){
		distance = power
	} else{
		distance = 0.9*oldPower + 0.1*power
	}

	//stroke("white")	
	theta += 10/180
	translate(canvasW/2, canvasH/2)
	rotate(theta)	

	translate(-canvasW/4, -canvasH/4)
	rotate(20*distance/180)
	drawSpectrumSquare(timeDomainData, distance*3, distance, 100)
	rotate(-20*distance/180)
	translate(canvasW/4, canvasH/4)


	translate(canvasW/4, -canvasH/4)
	rotate(-25*distance/180)
	drawSpectrumSquare(timeDomainData, distance*3, distance, 100)
	rotate(25*distance/180)
	translate(-canvasW/4, canvasH/4)


	translate(-canvasW/4, canvasH/4)
	rotate(-25*distance/180)
	drawSpectrumSquare(timeDomainData, distance*3, distance, 100)
	rotate(25*distance/180)
	translate(canvasW/4, -canvasH/4)


	translate(canvasW/4, canvasH/4)
	rotate(20*distance/180)
	drawSpectrumSquare(timeDomainData, distance*3, distance, 100)
	rotate(-20*distance/180)
	translate(-canvasW/4, -canvasH/4)

	translate(-canvasW/2, -canvasH/2)
	rotate(theta)
}

function drawSpectrumSquare(data, size, length, expansion){
	bufferLength = data.length
	sideLength = bufferLength/4

	for(var side = 0; side < 4; ++side){
		for(var i = 1; i < sideLength-1; ++i){
			normalisedData1 = data[side*sideLength+i]/256- 0.5
			normalisedData2 = data[side*sideLength+i+1]/256- 0.5
			switch(side){
				case 0:
					x1 = i*size/sideLength - size/2
					x2 = (i+1)*size/sideLength - size/2
					y1 = normalisedData1*expansion - length
					y2 = normalisedData2*expansion - length
					break;
				case 1:
					y1 = i*size/sideLength - size/2
					y2 = (i+1)*size/sideLength - size/2
					x1 = normalisedData1*expansion + length
					x2 = normalisedData2*expansion + length
					break;
				case 2:
					x1 = size - i*size/sideLength - size/2
					x2 = size - (i+1)*size/sideLength - size/2
					y1 = normalisedData1*expansion + length
					y2 = normalisedData2*expansion + length
					translate
					break;
				case 3:
					y1 = size - i*size/sideLength - size/2
					y2 = size - (i+1)*size/sideLength - size/2
					x1 = normalisedData1*expansion - length
					x2 = normalisedData2*expansion - length
					break;
			}
			line(x1,y1,x2,y2)
		}
	}
	oldPower = power
}

function getEnergy(data) {
	squareSum = 0
	for(var i = 0; i < data.length; ++i){
		x = data[i]/256 -0.5
		squareSum += x*x
	}
	rms = Math.sqrt(squareSum/data.length)
	db = 20.0*Math.log10(rms);
	return db 

}

</script>
</body>

</html>